version: '3.8'

services:
  postgres:
    image: postgres:16-alpine
    container_name: postgres
    restart: unless-stopped

    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
      POSTGRES_DB: postgres
      # Performance tuning
      POSTGRES_SHARED_BUFFERS: 256MB
      POSTGRES_EFFECTIVE_CACHE_SIZE: 1GB
      POSTGRES_WORK_MEM: 4MB
      POSTGRES_MAINTENANCE_WORK_MEM: 64MB

    ports:
      - "5432:5432"

    volumes:
      # Data persistence
      - postgres_data:/var/lib/postgresql/data

      # Custom configuration
      - ./postgresql.conf:/etc/postgresql/postgresql.conf:ro
      - ./pg_hba.conf:/etc/postgresql/pg_hba.conf:ro

      # Initialization scripts
      - ./init-scripts:/docker-entrypoint-initdb.d:ro

      # Backups
      - ./backups:/backups

    command: >
      postgres
      -c config_file=/etc/postgresql/postgresql.conf
      -c hba_file=/etc/postgresql/pg_hba.conf

    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

    networks:
      - postgres_network

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # PostgreSQL replica (optional)
  postgres-replica:
    image: postgres:16-alpine
    container_name: postgres-replica
    restart: unless-stopped

    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
      PGDATA: /var/lib/postgresql/data/pgdata

    ports:
      - "5433:5432"

    volumes:
      - postgres_replica_data:/var/lib/postgresql/data

    command: >
      postgres
      -c hot_standby=on

    depends_on:
      - postgres

    networks:
      - postgres_network

    profiles:
      - replica

  # pgAdmin - Web UI для управления
  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: pgadmin
    restart: unless-stopped

    environment:
      PGADMIN_DEFAULT_EMAIL: admin@example.com
      PGADMIN_DEFAULT_PASSWORD: ${PGADMIN_PASSWORD:-admin}
      PGADMIN_CONFIG_SERVER_MODE: 'False'
      PGADMIN_CONFIG_MASTER_PASSWORD_REQUIRED: 'False'

    ports:
      - "5050:80"

    volumes:
      - pgadmin_data:/var/lib/pgadmin
      - ./pgadmin/servers.json:/pgadmin4/servers.json:ro

    depends_on:
      - postgres

    networks:
      - postgres_network

    profiles:
      - tools

  # Prometheus PostgreSQL Exporter
  postgres-exporter:
    image: prometheuscommunity/postgres-exporter:latest
    container_name: postgres-exporter
    restart: unless-stopped

    environment:
      DATA_SOURCE_NAME: "postgresql://postgres:${POSTGRES_PASSWORD:-postgres}@postgres:5432/postgres?sslmode=disable"

    ports:
      - "9187:9187"

    depends_on:
      - postgres

    networks:
      - postgres_network

    profiles:
      - monitoring

  # Backup container (scheduled backups)
  postgres-backup:
    image: postgres:16-alpine
    container_name: postgres-backup
    restart: unless-stopped

    environment:
      POSTGRES_HOST: postgres
      POSTGRES_PORT: 5432
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
      POSTGRES_DB: postgres
      BACKUP_SCHEDULE: "0 2 * * *"  # 2 AM daily
      BACKUP_RETENTION_DAYS: 7

    volumes:
      - ./backups:/backups
      - ../scripts/backup-postgres.sh:/backup.sh:ro

    command: >
      sh -c "crond -f -l 2"

    depends_on:
      - postgres

    networks:
      - postgres_network

    profiles:
      - backup

volumes:
  postgres_data:
    driver: local
  postgres_replica_data:
    driver: local
  pgadmin_data:
    driver: local

networks:
  postgres_network:
    driver: bridge
