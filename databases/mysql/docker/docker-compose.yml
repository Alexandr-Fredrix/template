version: '3.8'

services:
  mysql:
    image: mysql:8.0
    container_name: mysql
    restart: unless-stopped

    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-rootpassword}
      MYSQL_DATABASE: ${MYSQL_DATABASE:-myapp}
      MYSQL_USER: ${MYSQL_USER:-myapp_user}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD:-password}

    ports:
      - "3306:3306"

    volumes:
      # Data persistence
      - mysql_data:/var/lib/mysql

      # Custom configuration
      - ./my.cnf:/etc/mysql/conf.d/custom.cnf:ro

      # Initialization scripts
      - ./init-scripts:/docker-entrypoint-initdb.d:ro

      # Backups
      - ./backups:/backups

    command: >
      --default-authentication-plugin=mysql_native_password
      --character-set-server=utf8mb4
      --collation-server=utf8mb4_unicode_ci

    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p${MYSQL_ROOT_PASSWORD}"]
      interval: 10s
      timeout: 5s
      retries: 5

    networks:
      - mysql_network

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # MySQL replica (optional)
  mysql-replica:
    image: mysql:8.0
    container_name: mysql-replica
    restart: unless-stopped

    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-rootpassword}

    ports:
      - "3307:3306"

    volumes:
      - mysql_replica_data:/var/lib/mysql
      - ./my-replica.cnf:/etc/mysql/conf.d/replica.cnf:ro

    depends_on:
      - mysql

    networks:
      - mysql_network

    profiles:
      - replica

  # phpMyAdmin - Web UI
  phpmyadmin:
    image: phpmyadmin:latest
    container_name: phpmyadmin
    restart: unless-stopped

    environment:
      PMA_HOST: mysql
      PMA_PORT: 3306
      PMA_USER: root
      PMA_PASSWORD: ${MYSQL_ROOT_PASSWORD:-rootpassword}
      UPLOAD_LIMIT: 128M

    ports:
      - "8080:80"

    depends_on:
      - mysql

    networks:
      - mysql_network

    profiles:
      - tools

  # MySQL Exporter для Prometheus
  mysql-exporter:
    image: prom/mysqld-exporter:latest
    container_name: mysql-exporter
    restart: unless-stopped

    environment:
      DATA_SOURCE_NAME: "root:${MYSQL_ROOT_PASSWORD:-rootpassword}@(mysql:3306)/"

    ports:
      - "9104:9104"

    depends_on:
      - mysql

    networks:
      - mysql_network

    profiles:
      - monitoring

  # Backup container
  mysql-backup:
    image: mysql:8.0
    container_name: mysql-backup
    restart: unless-stopped

    environment:
      MYSQL_HOST: mysql
      MYSQL_PORT: 3306
      MYSQL_USER: root
      MYSQL_PASSWORD: ${MYSQL_ROOT_PASSWORD:-rootpassword}
      MYSQL_DATABASE: ${MYSQL_DATABASE:-myapp}
      BACKUP_SCHEDULE: "0 2 * * *"
      BACKUP_RETENTION_DAYS: 7

    volumes:
      - ./backups:/backups
      - ../scripts/backup-mysql.sh:/backup.sh:ro

    command: >
      sh -c "crond -f -l 2"

    depends_on:
      - mysql

    networks:
      - mysql_network

    profiles:
      - backup

volumes:
  mysql_data:
    driver: local
  mysql_replica_data:
    driver: local

networks:
  mysql_network:
    driver: bridge
