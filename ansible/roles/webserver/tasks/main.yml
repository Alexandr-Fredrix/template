---
# Установка и настройка Nginx

- name: Install Nginx
  apt:
    name: nginx
    state: present
    update_cache: yes
  tags: install

- name: Create web root directories
  file:
    path: "{{ item.root }}"
    state: directory
    owner: "{{ app_user }}"
    group: "{{ app_group }}"
    mode: '0755'
  loop: "{{ nginx_sites }}"
  when: nginx_sites is defined
  tags: directories

- name: Remove default Nginx site
  file:
    path: /etc/nginx/sites-enabled/default
    state: absent
  notify: reload nginx
  tags: config

- name: Copy main Nginx configuration
  template:
    src: nginx.conf.j2
    dest: /etc/nginx/nginx.conf
    owner: root
    group: root
    mode: '0644'
    validate: 'nginx -t -c %s'
  notify: reload nginx
  tags: config

- name: Create Nginx site configurations
  template:
    src: site.conf.j2
    dest: "/etc/nginx/sites-available/{{ item.name }}"
    owner: root
    group: root
    mode: '0644'
  loop: "{{ nginx_sites }}"
  when: nginx_sites is defined
  notify: reload nginx
  tags: config, sites

- name: Enable Nginx sites
  file:
    src: "/etc/nginx/sites-available/{{ item.name }}"
    dest: "/etc/nginx/sites-enabled/{{ item.name }}"
    state: link
  loop: "{{ nginx_sites }}"
  when: nginx_sites is defined
  notify: reload nginx
  tags: config, sites

- name: Create SSL directories
  file:
    path: "{{ item }}"
    state: directory
    owner: root
    group: root
    mode: '0755'
  loop:
    - /etc/ssl/certs
    - /etc/ssl/private
  tags: ssl

- name: Copy SSL certificates
  copy:
    src: "{{ item.ssl_certificate }}"
    dest: "/etc/ssl/certs/{{ item.name }}.crt"
    owner: root
    group: root
    mode: '0644'
  loop: "{{ nginx_sites }}"
  when: nginx_sites is defined and item.ssl | default(false)
  notify: reload nginx
  tags: ssl

- name: Copy SSL private keys
  copy:
    src: "{{ item.ssl_certificate_key }}"
    dest: "/etc/ssl/private/{{ item.name }}.key"
    owner: root
    group: root
    mode: '0600'
  loop: "{{ nginx_sites }}"
  when: nginx_sites is defined and item.ssl | default(false)
  notify: reload nginx
  tags: ssl
  no_log: true

- name: Create Nginx cache directory
  file:
    path: "{{ nginx_cache_path }}"
    state: directory
    owner: www-data
    group: www-data
    mode: '0755'
  when: nginx_cache_enabled
  tags: cache

- name: Ensure Nginx is started and enabled
  systemd:
    name: nginx
    state: started
    enabled: yes
  tags: service

- name: Allow HTTP/HTTPS through firewall
  ufw:
    rule: allow
    port: "{{ item }}"
    proto: tcp
  loop:
    - 80
    - 443
  tags: firewall
