#!/bin/bash
# PostgreSQL Backup Script
# Generated by Ansible

BACKUP_DIR="{{ backup_directory }}"
RETENTION_DAYS={{ backup_retention_days }}
DATE=$(date +%Y%m%d_%H%M%S)

# Create backup directory if not exists
mkdir -p "${BACKUP_DIR}"

# Backup all databases
{% for db in postgresql_databases %}
pg_dump {{ db.name }} | gzip > "${BACKUP_DIR}/{{ db.name }}_${DATE}.sql.gz"
{% endfor %}

# Remove old backups
find "${BACKUP_DIR}" -name "*.sql.gz" -mtime +${RETENTION_DAYS} -delete

# Log
echo "$(date): Backup completed" >> "${BACKUP_DIR}/backup.log"
